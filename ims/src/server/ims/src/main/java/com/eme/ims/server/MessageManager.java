package com.eme.ims.server;import java.io.FileOutputStream;import java.io.IOException;import java.nio.charset.CharacterCodingException;import java.nio.charset.Charset;import java.nio.charset.CharsetDecoder;import java.nio.charset.CharsetEncoder;import org.apache.mina.core.buffer.IoBuffer;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import com.eme.ims.codec.Message;import com.eme.ims.codec.MsgProtocol;import com.eme.ims.utils.PropertyConfig;public enum MessageManager {		INSTANCE;	private Logger logger = LoggerFactory.getLogger(MessageManager.class);	private CharsetEncoder encoder = Charset.forName("utf-8").newEncoder();	private CharsetDecoder decoder = Charset.forName("utf-8").newDecoder();		private static transient int DEFAULT_SIZE = 164;	 	public int getMessageSize(Message message) {		int messageSize = 0;		try {			byte[] contents = message.getContents();			if (null != contents && contents.length>0) {				//byte[] bytes = message.getContents().getBytes("UTF-8");				messageSize = contents.length;			}		} catch (Exception e) {			e.printStackTrace();		}		return DEFAULT_SIZE + messageSize;	}			public IoBuffer  getStreamBuffer(Message message) throws CharacterCodingException{				int capacity = this.getMessageSize(message);				IoBuffer buffer = IoBuffer.allocate(capacity+4);				buffer.putInt(capacity);		buffer.putString(message.getUid(), encoder);		buffer.putString(message.getFrom(), encoder);		buffer.putString(message.getTo(), encoder);		buffer.putString(message.getGroupId(), encoder);				buffer.putInt(message.getCommandId());		buffer.putInt(message.getType().intValue());		buffer.putInt(message.getError().intValue());		buffer.putInt(message.getStatus().intValue());		buffer.putInt(message.getDirection().intValue());				//buffer.putString(message.getContents(), encoder);		buffer.put(message.getContents());		return buffer;			}	    		public Message fromStream (IoBuffer buffer, int capacity, PropertyConfig config) throws CharacterCodingException {				Message message = new Message();				message.setUid(buffer.getString(36,decoder));		logger.debug("uid:["+message.getUid()+"]");		message.setFrom(buffer.getString(36, decoder));		logger.debug("from:["+message.getFrom()+"]");				message.setTo(buffer.getString(36, decoder));		logger.debug("to:["+message.getTo()+"]");				message.setGroupId(buffer.getString(36, decoder));		logger.debug("group Id:["+message.getGroupId()+"]");						message.setCommandId(buffer.getInt());		logger.debug("command id:" + message.getCommandId().intValue());				message.setType(Integer.valueOf(buffer.getInt()).shortValue());		logger.debug("type:["+message.getType()+"]");				message.setError(Integer.valueOf(buffer.getInt()).shortValue());		logger.debug("ErrorId:["+message.getError()+"]");				message.setStatus(Integer.valueOf(buffer.getInt()).shortValue());		logger.debug("status:["+message.getStatus()+"]");				message.setDirection(Integer.valueOf(buffer.getInt()).shortValue());		logger.debug("direction:["+message.getDirection()+"]");				if (message.getType() == MsgProtocol.MsgType.VOICE) {			logger.debug("message type : voice");			if (message.getDirection() == MsgProtocol.MsgDirection.CLIENT_TO_SERVER) {				byte[] audio = new byte[capacity-164];				buffer.get(audio);				String path = config.getString("audio.folder");				String fileName = message.getUid()+".aac";			    try {			    	FileOutputStream fos = new FileOutputStream(path+fileName);	    			fos.write(audio, 0, audio.length);	    			fos.flush();	    			fos.close();	    			String url = "http://"+config.getString("server.host")+"/audio/"+fileName;					message.setContents(url.getBytes());					logger.debug(fileName); 				} catch (IOException e) {					logger.debug("failed to save file to disk.");				}			} else {				message.setContents(buffer.getString(decoder).getBytes());				logger.debug("message:["+message.getContents()+"]");			}		} else {			message.setContents(buffer.getString(decoder).getBytes());			logger.debug("message:["+message.getContents()+"]");		}				message.setEventTime(System.nanoTime());		return message;	}	  }